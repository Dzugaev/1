--1--
select distinct st.name, st.surname, h.name
from students st, hobbies h, students_hobbies sh
where sh.student_id = sh.hobby_id
group by st.name, st.surname, h.name
order by st.surname
/*
select st.surname, h.name
from students st, hobbies h, students_hobbies sh
where st.surname = 'Дзугаев' and h.id=sh.hobby_id
group by st.surname, h.name*/


--2--
with tab as(
select sh.student_id, extract (month from age (now(), sh.date_start)) as maximum
from students_hobbies sh
where sh.date_finish is null
group by sh.student_id, sh.date_start
order by maximum desc
limit 1)
select st.*
from students st
inner join tab
on st.id = tab.student_id

--3--
select st.name, st.surname, st.score, avg(st.score), sum(h.risk)
from students st
inner join students_hobbies sh
on st.id=sh.student_id
inner join hobbies h
on h.id = sh.hobby_id
group by st.name, st.surname, st.score
having sum(h.risk)>0.9 and st.score>(select avg(score) from students)

--4--
select st.name, st.surname, st.id, st.birth_date, h.name, (extract (month from age (sh.date_finish, sh.date_start))+extract (year from age (sh.date_finish, sh.date_start))*12) as dlitel
from students st
inner join students_hobbies sh
on st.id=sh.student_id
inner join hobbies h
on h.id = sh.hobby_id
where sh.date_finish is not null
group by st.name, st.surname, st.id, st.birth_date, h.name, dlitel

--5--
select st.name, st.surname, st.id, st.birth_date
from students st
inner join students_hobbies sh
on st.id=sh.student_id
inner join hobbies h
on h.id = sh.hobby_id
where (sh.date_finish is null) and (extract (year from st.birth_date ) > 1999)
group by st.name, st.surname, st.id, st.birth_date
having count(*) > 1


--6
with new_table as
(select sh.student_id
from students_hobbies sh
where sh.date_finish is null
Group by sh.student_id
Having count(*)>=1)

select avg(st.score),st.n_group
from students st
inner join new_table nt
on st.id=nt.student_id
Group by st.n_group

--7
select h.name, h.risk, extract(month from age(sh.date_finish,sh.date_start))+extract(year from age(sh.date_finish,sh.date_start))*12,st.n_group,
from students_hobbies sh
inner join students st
on sh.student_id=st.id
inner join hobbies h
on sh.hobby_id=h.id
Group by h.name, h.risk, extract(month from age(sh.date_finish,sh.date_start))+extract(year from age(sh.date_finish,sh.date_start))*12,st.n_group,
Having extract(month from age(sh.date_finish,sh.date_start))+extract(year from age(sh.date_finish,sh.date_start))*12=
(
select max(extract(month from age(sh.date_finish,sh.date_start))+extract(year from age(sh.date_finish,sh.date_start))*12)
from students_hobbies sh
)

--10 групповые
with t as
(
select st.n_group,max(st.score) as m
from students st
Group by st.n_group
)
select st.*
from students st
inner join t
on st.n_group=t.n_group
and st.score=t.m


--11
select t1.n_group
from
(select st.n_group, count(st.*) as A
from students st
group by st.n_group) as t1
inner join
(select st.n_group, count(st.*) as B
from students st
where st.score>=4
group by st.n_group) as t2
on t1.n_group=t2.n_group
where t2.B::real/t1.A::real>=0.6;

--12
select count(h.name), st.n_group
from students st inner join students_hobbies sh on st.id = sh.student_id inner join hobbies h on sh.hobby_id = h.id
where sh.date_finish is null
group by st.n_group;

--16

with h_c as(
select sh.hobby_id, count(*)as c
from students_hobbies sh
Group by sh.hobby_id
)
Select h_c.hobby_id
from h_c
where h_c.c=
(
select max(c)
from h_c
)
